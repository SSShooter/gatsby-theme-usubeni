---
path: '/build-a-pwa'
date: '2018-09-17T08:00:00.000Z'
title: 'ä¸€ä¸ª PWA çš„è¯ç”Ÿ'
tags: ['coding']
---

PWAï¼ˆProgressive Web Appsï¼‰è™½ç„¶æ˜¯ç½‘é¡µåº”ç”¨ï¼Œä½†æ˜¯å¯ä»¥å¸¦æ¥åª²ç¾åŸç”Ÿçš„ç”¨æˆ·ä½“éªŒï¼Œå…¶ä¸­åŒ…å«ç¦»çº¿å¯ç”¨ï¼Œåå°æ¨é€ç­‰åŠŸèƒ½ã€‚PWA ä¸æ˜¯ä¸€ä¸ªæ–°åè¯ï¼Œæ—©åœ¨ 2015 å¹´å·²ç»æå‡ºè¿™ä¸ªæ€æƒ³ï¼Œä½†æ˜¯ç›´åˆ° iOS12 çš„å‘å¸ƒï¼ŒPWA ç»ˆäºå¯ä»¥åœ¨ iOS ä¸­æ·»åŠ åˆ°ä¸»å±ï¼Œåªæœ‰å®‰å“å’Œ iOS éƒ½èƒ½ä½¿ç”¨ PWA çš„åŸºæœ¬åŠŸèƒ½ï¼Œå®ƒæ‰ç®—æ˜¯çœŸçš„å¼€å§‹èµ°è¿‘å¤§ä¼—ã€‚æƒ³äº†è§£ PWAï¼Œå¯ä»¥çœ‹çœ‹ç™¾åº¦çš„ [LAVAS](https://lavas.baidu.com/pwa) å®˜ç½‘ï¼Œåœ¨å›½å†…ç½‘ç«™ä¸­ LAVAS å®˜ç½‘ä¼šæœ‰æ¯”è¾ƒå®Œæ•´çš„ PWA èµ„æ–™ã€‚

æœ¬æ–‡å¯ä»¥æå‰è®©å¤§å®¶ç†Ÿæ‚‰ PWA æ­å»ºï¼Œæ–‡ä¸­æåˆ°çš„é…ç½®æ¥è‡ªä¸€ä¸ª Redesign çš„ [nipponcolors](http://nipponcolors.com/)ï¼Œæœ€è¿‘æ‰åšå¥½çš„ï¼Œä½¿ç”¨çš„å„ç§åº“éƒ½æ˜¯ç°åœ¨ï¼ˆ2018.09.14ï¼‰æœ€æ–°çš„ï¼Œå¯ç”¨çš„ï¼Œå¦å¤–æœ¬æ–‡ä¸è®¨è®ºåº”ç”¨åŠŸèƒ½ï¼Œå•çº¯è®²è®² PWA çš„æ­å»ºã€‚

ä»“åº“åœ°å€ï¼šhttps://github.com/ssshooter/nippon-color
ç½‘é¡µåœ°å€ï¼šhttps://ssshooter.github.io/nippon-color/#/

## æ­å»º

### ä½¿ç”¨ [Vue-cli3](https://cli.vuejs.org/guide/creating-a-project.html#vue-create)

Vue-cli3 ä¸ 2 çš„åŒºåˆ«æŒºå¤§çš„ï¼Œ3 é»˜è®¤æ­å»ºå·¥ç¨‹å¹¶éåƒ 2 ä¸€æ ·æ‹‰å–æ¨¡æ¿ï¼Œè€Œæ˜¯è‡ªå·±é€‰æ‹©éœ€è¦çš„ feature ç”Ÿæˆé¡¹ç›®ã€‚

![Vue-cli3](Vue-cli3.png)

è¦ç”Ÿæˆ PWA é¡¹ç›®è¯·å‹¾ä¸Š `PWA Support`

### Vue-cli3 çš„ä¸€ä¸ªå…³äº HMR çš„å·²çŸ¥é—®é¢˜

[Issue åœ°å€](https://github.com/vuejs/vue-cli/issues/1559)
å‡è®¾å¤§å®¶éƒ½çŸ¥é“ HMRï¼ˆçƒ­æ¨¡å—æ›´æ–°ï¼‰æ˜¯ä»€ä¹ˆäº†ï¼Œvue-cli3 çš„æŸäº›ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªé—®é¢˜ï¼ŒHMR æ— æ³•ä½¿ç”¨ï¼Œæ§åˆ¶å°å°±ä¸€ç›´æ˜¾ç¤º waiting è¿æ¥ï¼Œæ–‡ä»¶ä¸€æ”¹ç›´æ¥æ˜¾ç¤ºè¿æ¥æ–­å¼€ã€‚è§£å†³æ–¹æ¡ˆæœ‰äºŒï¼š

1. å¦‚æœä½ çš„ä¾èµ–ä½¿ç”¨ cnpm å®‰è£…ï¼Œå°è¯•åˆ æ‰ `node_modules` åä½¿ç”¨ npm ä¸‹è½½ã€‚
2. åœ¨ `vue.config.js` ä½œä»¥ä¸‹é…ç½®
   ```
   chainWebpack: config => {
       config.resolve.symlinks(true)
       return config
   },
   ```

## å€¼å¾—æ³¨æ„çš„é…ç½®

### eslint é…ç½®

åœ¨è¿™é‡Œé¦–å…ˆæ¨èä¸€ä¸‹å°¾é€—å·ï¼ŒåŠ ä¸Šå°¾é€—å·çš„å¥½å¤„åªæœ‰ä¸€ä¸ªï¼Œä½†çœŸçš„ååˆ†é‡è¦ï¼Œé‚£å°±æ˜¯ diff ä¼šéå¸¸å¥½çœ‹ã€‚ç„¶å [eslint-plugin-vue](https://eslint.vuejs.org/) æ’ä»¶æ˜¯ä¸€äº›é¢„è®¾è§„åˆ™ç»„åˆï¼Œåˆ† baseï¼Œessentialï¼Œstrongly-recommendedï¼Œrecommended å››çº§ï¼Œè¯·è‡ªç”±é€‰æ‹©ï¼Œæ²¡æœ‰æœ€å¥½çš„æ­é…ï¼Œåªè¦ç”¨å¾—èˆ’æœå°±å¥½ï¼Œå›¢é˜Ÿåˆä½œè¿˜æ˜¯éå¸¸æ¨èå®šå¥½ eslint è§„åˆ™ï¼Œä½¿ç”¨å°½é‡è¯¦ç»†çš„åŒä¸€å¥—è§„åˆ™ï¼Œåœ¨ä»£ç åˆå¹¶æ—¶æ„Ÿè§‰ä¼šéå¸¸çˆ½å¿«ã€‚

![eslintrc](eslintrc.png)

è®¾ç½® eslint åå»ºè®®é…ç½®å¼€å‘æœåŠ¡å™¨çš„ overlay é€‰é¡¹ï¼Œåœ¨ eslint æŠ¥é”™æ—¶ä¼šè¦†ç›–åœ¨é¡µé¢ä¸Šï¼Œæ—¶åˆ»æé†’ä½ å†™ä»£ç å¾—æœ‰ä¿¡æ¡ã€‚

```
  devServer: {
    overlay: {
      warnings: true,
      errors: true,
    },
  },
```

## èµ„æºä¼˜åŒ–

### å›¾ç‰‡

vue-cli3 æ­å»ºçš„å·¥ç¨‹æ²¡æœ‰è‡ªå¸¦å›¾ç‰‡ä¼˜åŒ–æ’ä»¶ï¼Œæ‰€ä»¥è¯·è‡ªè¡Œå®‰è£…ã€‚æœ‰æ›´å¥½çš„å›¾ç‰‡å‹ç¼©æ’ä»¶æ±‚æ¨èå•¦ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ `imagemin-webpack-plugin`ï¼ŒåŸºæœ¬é…ç½®å¦‚ä¸‹ï¼š

```
var ImageminPlugin = require('imagemin-webpack-plugin').default
// Or if using ES2015:
// import ImageminPlugin from 'imagemin-webpack-plugin'

module.exports = {
  plugins: [
    // Make sure that the plugin is after any plugins that add images
    new ImageminPlugin({
      disable: process.env.NODE_ENV !== 'production', // Disable during development
      pngquant: {
        quality: '95-100'
      }
    })
  ]
}
```

### å­—ä½“

å¯¹äºä¸­æ–‡ç«™ç‚¹ï¼Œå­—ä½“é—®é¢˜å¯æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œå› ä¸ºä¸­æ–‡å­—ä½“å®åœ¨å¤ªå¤ªå¤ªå¤ªå¤§äº†ï¼Œéšéšä¾¿ä¾¿ä¸€ä¸ªéƒ½ 10m äº†ï¼Œç­‰å¾…è¿™ä¸œè¥¿ä¸‹è½½çœŸçš„çµ¦ç”¨æˆ·ä½“éªŒå¸¦æ¥è‡´å‘½æ‰“å‡»ï¼Œä½†æ˜¯ï¼ä½†æ˜¯ï¼æœ‰è¿™ä¹ˆä¸€ä¸ªç¨‹åºï¼

#### [font-spider-plus](https://github.com/allanguys/font-spider-plus)

ä¹‹å‰ä¸€ç›´çŸ¥é“ font-spiderï¼Œå®ƒçš„åŠŸèƒ½æ˜¯è·å–ä½¿ç”¨åˆ°çš„å­—ä½“ï¼Œç„¶ååˆ†æå‡ºä½¿ç”¨äº†æ”¹å­—ä½“çš„å­—ç¬¦ï¼Œæœ€åæŠŠå­—ç¬¦æŠ½ç¦»å‡ºæ¥ã€‚è¿™å¤§å¤§å‡å°‘äº†ä¸­æ–‡å­—ä½“çš„ä½“ç§¯ï¼Œä½†æ˜¯ç¼ºä¸èƒ½ç”¨äº js æ¸²æŸ“çš„ç½‘é¡µï¼Œåæ¥æ‰æ‰¾åˆ° font-spider-plusï¼Œè™½ç„¶è¦æ‰‹åŠ¨æ“ä½œä¸€ä¸‹ï¼ˆæœ€ç®€å•çš„æ–¹æ³•ï¼šå‘å¸ƒç½‘é¡µä¹‹åç”¨ fsp æŠŠç”¨åˆ°çš„å­—çˆ¬å‡ºæ¥ï¼‰ï¼Œä½†æ˜¯å¾—åˆ°çš„ä¼˜åŒ–çœŸçš„å¾ˆå¤§å“¦ï¼

## å“åº”å¼è®¾è®¡

PWA ç»™äº†æˆ‘ä»¬ä¸€ä¸ªå¾ˆç®€å•çš„è·¨å¹³å°æ–¹æ³•ï¼Œä¸åªæœ‰ç§»åŠ¨ç«¯å¯ä»¥æ·»åŠ åˆ°é¦–å±ï¼ŒPC ç«¯ä¹ŸåŒæ ·å¯ä»¥ï¼Œæ‰€ä»¥å“åº”å¼è®¾è®¡å¯¹ PWA å¯ä»¥è¯´æ˜¯å¿…é¡»çš„ã€‚
PC ç«¯çš„æ·»åŠ æ–¹æ³•åœ¨ F12 é‡Œï¼Œè‡³äºæ›´åŠ æ–¹ä¾¿çš„æ–¹æ³•...å¥½åƒæ˜¯è¦æ”¹ flag æ‰èƒ½ç”¨ï¼Œé‚£ä¹ˆä¹Ÿè°ˆä¸ä¸Šå¤šæ–¹ä¾¿äº†ï¼Œæ‰€ä»¥ä¸ä»‹ç»äº†ï¼Œç­‰åˆ°æ­¤é¡¹æŠ€æœ¯æ›´åŠ æˆç†Ÿï¼Œæƒ³å¿…è¿™ä¸ªæŒ‰é’®å°±ä¼šå‡ºç°åœ¨æ˜¾çœ¼çš„ä½ç½® ğŸ˜‚

![add-to-homescreen.png](add-to-homescreen.png)

## PWA ä¸“å±é—®é¢˜

å»ºè®®ä½¿ç”¨ LightHouse ç»™ä½ çš„ PWA è¯„åˆ†ï¼ŒæŠ¥å‘Šä¸­è¿˜ä¼šå¸¦æœ‰ä¿®æ”¹å»ºè®®ï¼Œååˆ†å®ç”¨ã€‚

![light-house.png](light-house.png)

### manifest.json

PWA æ·»åŠ è‡³æ¡Œé¢çš„åŠŸèƒ½å®ç°ä¾èµ–äº `manifest.json`ã€‚è¿™ä¸ªæ–‡ä»¶ç»“æ„å¾ˆç®€å•ï¼Œå¡«å†™å¯¹åº”å­—æ®µå³å¯ï¼Œå¯åœ¨[è¿™é‡Œ](https://lavas.baidu.com/pwa/engage-retain-users/add-to-home-screen/introduction)äº†è§£è¯¦æƒ…ã€‚

### Service Worker åˆ·æ–°

é’ˆå¯¹ PWA åŠŸèƒ½æ¥è¯´ï¼Œé¡¹ç›®æˆåŠŸç”Ÿæˆå°±å·²ç»é…ç½®å¥½ç¦»çº¿ç¼“å­˜åŠŸèƒ½ï¼Œå¯¹ Service Worker ä¸ç†Ÿæ‚‰çš„åŒå­¦æ¥è¯´å¯ä»¥è¯´å¾ˆæ–¹ä¾¿äº†ã€‚ä½†æ˜¯å¯¹äºæ¨é€åŠŸèƒ½å’Œ Service Worker çš„æ›´å¤šç»†èŠ‚ä»ç„¶éœ€è¦æ·±å…¥ç ”ç©¶æ‰èƒ½æµç•…ä½¿ç”¨è¿™ä¸ªæ–°å…´ç©æ„ã€‚
ï¼ˆä»¥ä¸‹ç§° Service Worker ä¸º SWï¼‰
æœ‰ä¸€ä¸ªé—®é¢˜ç‰¹åˆ«å€¼å¾—æ³¨æ„ï¼Œé‚£å°±æ˜¯ SW çš„æ›´æ–°é—®é¢˜ã€‚SW æ§åˆ¶é¡¹ç›®ç¯å¢ƒçš„ç¼“å­˜ï¼Œä½†æ˜¯ SW æ›´æ–°åæ€ä¹ˆåˆ·æ–°ç¼“å­˜å°±ä¸é‚£ä¹ˆå®¹æ˜“ç†è§£äº†ã€‚SW æ›´æ–°åï¼Œä¼šè¿›å…¥ waiting çŠ¶æ€ï¼Œæ—§çš„ SW ä¾æ—§æ­£å¸¸è¿è¡Œï¼Œæ‰€ä»¥æ–°çš„ SW æ— æ³•æ¿€æ´»ï¼Œä½ éœ€è¦å…³é—­æ•´ä¸ªæµè§ˆå™¨æ‰èƒ½æŠŠæ—§çš„ SW å…³é—­ï¼Œå†æ¬¡æ‰“å¼€ç½‘é¡µå°±èƒ½çœ‹åˆ°æ–°çš„ SW è¿ä½œäº†ã€‚
æœ‰ä¸€ä¸ªæ–¹ä¾¿ä¸€ç‚¹çš„æ–¹æ³•ï¼Œé…ç½®

```
    workboxOptions: {
      skipWaiting: true,
      clientsClaim: true,
    },
```

ä¹‹åï¼Œç¬¬ä¸€ä¸ªé€‰é¡¹å¦‚å…¶å­—é¢æ„æ€ï¼Œä¼šè·³è¿‡ Waiting çŠ¶æ€ï¼Œè€Œ clientsClaim å¯ä»¥è®© SW è¿›å…¥ activated çŠ¶æ€åç«‹å³æ§åˆ¶é¡µé¢ï¼ˆä½†æ˜¯å®é™…ä¸Šï¼ŒSW å³ä½¿ç«‹åˆ»æ§åˆ¶é¡µé¢å¹¶è¾“å‡ºæ–°æ•°æ®ï¼ŒSPA ä¹Ÿè¦åˆ·æ–°æ‰èƒ½æ¸²æŸ“ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œä½†è¿™ä¹Ÿæ€»æ¯”å…³é—­æµè§ˆå™¨å¥½å¤šäº†ï¼‰ã€‚
è¯¦ç»†åŸç†è¯·æŸ¥é˜…[è°·æ­Œå®˜æ–¹èµ„æ–™](https://developers.google.com/web/fundamentals/primers/service-workers/lifecycle)ï¼ˆéœ€è¦æ¢¯å­ï¼‰ã€‚

#### æœ€åï¼Œç»™ä½ ä¸€ä¸ªä½›ç³»åˆ·æ–°æ–¹æ³•

> Service Worker çš„ç‰¹æ®Šä¹‹å¤„é™¤äº†ç”±æµè§ˆå™¨è§¦å‘æ›´æ–°ä¹‹å¤–ï¼Œè¿˜åº”ç”¨äº†ç‰¹æ®Šçš„ç¼“å­˜ç­–ç•¥ï¼š å¦‚æœè¯¥æ–‡ä»¶å·² 24 å°æ—¶æ²¡æœ‰æ›´æ–°ï¼Œå½“ Update è§¦å‘æ—¶ä¼šå¼ºåˆ¶æ›´æ–°ã€‚è¿™æ„å‘³ç€æœ€åæƒ…å†µä¸‹ Service Worker ä¼šæ¯å¤©æ›´æ–°ä¸€æ¬¡ã€‚

### Preload

![preload.png](preload.png)

è¿™ä¸ªæ˜¯ Lighthouse æé†’æˆ‘çš„ã€‚å¯¹äºä¸€äº›å¿…è¦çš„èµ„æºï¼Œå¯ä»¥ä½¿ç”¨ Preload é¢„å…ˆä¸‹è½½ï¼ˆç‰¹åˆ«æ˜¯å­—ä½“æˆ–å›¾ç‰‡ç­‰èµ„æºï¼‰ï¼Œä¸å¿…ç­‰ä½¿ç”¨æ—¶å†ä¸‹è½½ï¼Œè¿™åˆå°†ä¼šæ˜¯å‡ ç™¾æ¯«ç§’çš„ç­‰å¾…ã€‚æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒ vue-cli å®˜ç½‘ç›¸å…³é¡µé¢ï¼šhttps://cli.vuejs.org/zh/guide/html-and-static-assets.html#preload

## æœ€å

å®Œæ•´é…ç½®åœ°å€
https://github.com/ssshooter/nippon-color/blob/master/vue.config.js
https://github.com/ssshooter/nippon-color/blob/master/.eslintrc.js
è¿™æ˜¯ä¸€ä¸ªæœ€æœ€ç®€å•çš„ PWAï¼Œæ²¡æœ‰å¯¹ SW è¿›è¡Œæ·±åº¦é…ç½®ï¼Œå¾ˆå¤šåŠŸèƒ½æ²¡æœ‰ç”¨ä¸Šã€‚Vue-cli3 æ­å»ºçš„é¡¹ç›®ä½¿ç”¨ [`workbox-webpack-plugin`](https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin)ï¼ŒSW é»˜è®¤æ˜¯è‡ªå·±ç”Ÿæˆçš„ï¼Œéœ€è¦è‡ªå·±é™„åŠ  SW åŠŸèƒ½å¯ä»¥ä½¿ç”¨ InjectManifest æ’ä»¶ã€‚æœ€åæä¸€ä¸‹ [Lavas App](https://lavas.baidu.com/app)ï¼Œå¯ä»¥æŠŠä½ çš„ PWA åŒ…è£…æˆä¸€ä¸ª apkï¼Œæœ¬è´¨æ˜¯å¿«æ·æ–¹å¼ï¼Œæ–¹ä¾¿äº†è¿˜æ²¡æ”¯æŒ PWA çš„å®‰å“ç³»ç»Ÿã€‚

å¦‚æœæœ‰å…¶ä»–é—®é¢˜ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºè®¨è®º~
